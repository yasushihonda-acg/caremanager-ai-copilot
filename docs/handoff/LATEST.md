# ハンドオフメモ

**最終更新**: 2026-02-20（セッション19）

## 現在のステージ

**Stage 3: Pilot Deployment** - 3-5名のケアマネージャーへの実際の展開フェーズ

> Stage 2（Production Readiness）完了: AI精度90%実証・エラーハンドリング監査・CI/CD正常稼働を達成

## 直近の変更（セッション19: テスト強化 / セッション18: モバイル最適化 #26）

| 日付 | コミット | 内容 |
|------|----------|------|
| 2026-02-20 | 100a794 | test: Firestoreセキュリティルールテスト追加 (#40) (#45) |
| 2026-02-20 | a12ea1a | test: E2Eテスト実装（Playwright + Firebase Emulator）(#37) (#44) |
| 2026-02-20 | 24dd2e4 | test: FE/BE整合性テスト追加 (#38) |
| 2026-02-20 | 1beadf5 | feat: モバイル（スマートフォン）操作性最適化 (#26) |
| 2026-02-20 | 6b0115d | feat: ケアプランと関連記録の連携強化 (#25) (#42) |

### 対応済みIssue

| Issue | 内容 | コミット |
|-------|------|----------|
| #40 | Firestoreセキュリティルールテスト追加 | 100a794 ✅ クローズ済 |
| #37 | E2Eテスト実装（Playwright） | a12ea1a ✅ クローズ済 |
| #38 | FE/BE整合性テスト | 24dd2e4 ✅ クローズ済 |
| #26 | モバイル（スマートフォン）操作性最適化 | 1beadf5 ✅ クローズ済 |
| #25 | ケアプランと関連記録の連携強化 | 6b0115d ✅ クローズ済 |

## 実装状況

| 機能 | 状態 | 備考 |
|------|------|------|
| 認証（Googleログイン） | ✅ | Firebase Auth |
| アセスメント（23項目） | ✅ | 保存・読込・履歴 |
| ケアプラン（第1表・第2表） | ✅ | AI生成・印刷プレビュー |
| ケアプラン履歴・ステータス管理 | ✅ | CarePlanSelector / CarePlanStatusBar |
| ケアプランV2編集 | ✅ | NeedEditor / CarePlanV2Editor |
| 第3表（週間サービス計画表） | ✅ | WeeklyScheduleEditor / Preview / 印刷対応 |
| モニタリング記録 | ✅ | 差分入力・履歴一覧 |
| 支援経過記録（第5表） | ✅ | 音声入力対応 |
| サービス担当者会議（第4表） | ✅ | |
| 入院時情報連携シート | ✅ | 自動生成 |
| 複数利用者管理 | ✅ | Firestoreネスト方式 |
| Firebase Emulator環境 | ✅ | PR #11 |
| ニーズ→目標の整合性チェック | ✅ | PR #15 |
| アクセス制御（allowed_emails） | ✅ | Stage 3実装（f6788c3） |
| フィードバックFAB | ✅ | Stage 3実装（f6788c3） |
| 利用ログ・structured logging | ✅ | Stage 3実装（f6788c3） |
| 第1表「本人・家族等の意向」 | ✅ | #19（c6a67c6） |
| 第2表「目標期間」フィールド | ✅ | #18（PR#34マージ済） |
| ケアマネ情報Firestore管理 | ✅ | #20（PR#34マージ済） |
| Safari/iPhone音声入力互換 | ✅ | #21（PR#34マージ済） |
| 認定有効期限アラート | ✅ | #22（77116b2）|
| モニタリング期限アラート | ✅ | #22（77116b2） |
| 初回利用オンボーディング・操作ガイド | ✅ | #23（fb5c728） |
| ダッシュボード/業務サマリー画面 | ✅ | #24（b5d727c） |
| ケアプランと関連記録の連携強化 | ✅ | #25（6b0115d） |
| デモ環境1コマンド起動 | ✅ | #35（0ca5660） |
| モバイル操作性最適化 | ✅ | #26（1beadf5） |

## 次のアクション

| # | タスク | 状態 | 依存 |
|---|--------|------|------|
| 1 | **#43 Issue クローズ**（#37/#38/#40完了済みのため） | 🔲 | なし |
| 2 | **本番ログイン修正: OAuthクライアントredirect URI設定 #36** | 🔲 P1 | テスト完了済 |
| 3 | **#39 コンポーネントテスト追加** | 🔲 P1 | なし |
| 4 | **パイロットユーザーのメールアドレス登録** | 🔲 手動 | #36解決後 |
| 5 | パイロットユーザーへの案内 | 🔲 | 登録後 |

### オープンIssue（優先順）

| Issue | 優先 | タイトル |
|-------|------|----------|
| **#43** | **P0** | **テストファースト戦略（#37/#38/#40完了→#36へ）** ※要クローズ |
| **#36** | **P1** | **本番ログイン修正：OAuthクライアントredirect URI設定** |
| #39 | P1 | コンポーネントテスト追加 |
| #29 | P2 | 非同期エラーハンドリング改善 |
| #27 | P2 | 支援経過記録の検索・日付フィルタ |
| #28 | P2 | インタビューコパイロット未実装 |
| #30 | P2 | 保険者番号バリデーション |
| #31 | P2 | 保存ボタン位置・挙動の一貫性 |
| #32 | P3 | ケアプランPDF直接出力 |
| #33 | P3 | 定型文データベースのV2対応 |

### Stage 3 退出基準チェックリスト

- [ ] パイロットユーザー3-5名が実際に使用
- [ ] 満足度80%以上
- [ ] 重大バグ0件（1ヶ月間）
- [ ] フィードバックの集計・分析完了

### パイロットユーザー登録方法

```bash
# Firebaseコンソールから手動で登録
# allowed_emails コレクション → ドキュメントID = メールアドレス
# フィールド: { createdAt: <Timestamp>, note: <説明> }
```

## デモ環境

- アプリ: https://caremanager-ai-copilot-486212.web.app
- ドキュメント: https://yasushihonda-acg.github.io/caremanager-ai-copilot/
- GCPプロジェクト: `caremanager-ai-copilot-486212`
- GCPオーナー: `yasushi.honda@aozora-cg.com`

## ローカル開発（Emulator）

```bash
# Emulator起動（Auth:9099, Firestore:8080, Functions:5001）
npm run dev:emulator

# Vite起動（自動でEmulator接続、テストユーザー自動ログイン）
npm run dev

# シードデータ投入（allowed_emails含む）
npm run dev:seed
```

環境変数: `.env.development` の `VITE_USE_EMULATOR=true`

## 注意事項

- Emulator環境では `checkEmailAllowed` は常に `true` を返す（バイパス済み）
- `allowed_emails` コレクションへのクライアント書き込みは `firestore.rules` で禁止済み（`allow write: if false`）
- フィードバックは `feedback` コレクションに保存（閲覧はFirebaseコンソールまたは管理スクリプトで）
- `usage_logs` はケアプラン生成時のみ記録（最小限）
- ADR 0008（Clientネストスキーマ）、ADR 0009（ステージベース開発モデル）、ADR 0010（GCPプロジェクト移行）、ADR 0011（期限アラート定義）作成済み
- #26 Issue は確認済みクローズ済み（CLOSED状態）
- #37/#38/#40 テスト実装済み・クローズ済み
- **#43 Issue（テストファースト戦略）はオープン中だが、#37/#38/#40がすべてクローズされたため次セッション冒頭でクローズすること**
- CI（Deploy to Firebase）が #45 マージ後に in_progress 中 → 完了後に本番反映確認推奨
