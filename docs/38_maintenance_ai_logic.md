# 38_maintenance_ai_logic.md - v1.2.1 Maintenance Plan: AI Logic Refinement

## 1. 概要
*   **対応バージョン:** v1.2.1
*   **目的:** ユーザビリティ向上（要約生成タイミングの最適化）および AIケアプラン作成機能の安定化。

## 2. 改修テーマ A: リアルタイム要約の廃止と最終生成への一本化

### 課題 (Issue)
*   録音中（30秒おき）に要約テキストが生成・更新されると、ユーザーが「もう書き込まれた」と誤認し、録音終了前に転記ボタンを押してしまう誤操作（フライング）を誘発しやすい。
*   途中経過の要約は不完全であり、実用性が低い。

### 変更仕様 (Specification Change)
*   **インターバル解析 (Polling):**
    *   構造化データ（チェックボックス等）の更新 **のみ** を行う。
    *   `summary` フィールドは生成しない（または空文字を返す）。
    *   アドバイス（Co-pilot）は継続して生成する。
*   **最終解析 (On Stop):**
    *   構造化データの最終更新を行う。
    *   **ここで初めて `summary` (特記事項要約) を生成する。**

### 実装方針
*   `services/geminiService.ts` の `analyzeAssessmentConversation` 関数に `isFinal` フラグを追加（またはモード分け）。
*   `isFinal = false` の場合、プロンプトで「要約は不要」と指示し、レスポンススキーマから `summary` を除外、あるいは無視する。

## 3. 改修テーマ B: ケアプラン自動作成のエラーハンドリング強化

### 課題 (Issue)
*   「作成」ボタン押下時に `500 Internal Error` や `net::ERR_FAILED` が発生し、UIが無反応になる場合がある。
*   一部の環境で、意図しないタイミング（エンターキー等）で処理が走ってしまう挙動が報告されている。

### 原因仮説
1.  **フォーム送信の暴発:** `input` 要素内で Enter キーを押した際、フォームサブミット扱いになり、ハンドラが意図せず呼ばれている可能性がある。
2.  **APIタイムアウト/エラー:** 生成に時間がかかりすぎている、またはプロンプトが複雑すぎる。

### 対策 (Solution)
1.  **UIイベント制御:** テキスト入力欄での `onKeyDown` イベントで `Enter` を検出した際、明示的に `preventDefault()` を行い、意図しない実行を防ぐ。
2.  **エラーハンドリング:** `generateCarePlanDraft` 呼び出しを `try-catch` で囲み、エラー時はアラートだけでなく、コンソールに詳細ログを出力し、ローディング状態を確実に解除する。
3.  **フォールバック:** 万が一 JSON パースに失敗した場合の安全策を講じる。

## 4. スケジュール
*   **計画策定:** 2025-12-03 (完了)
*   **実装:** 即時 (v1.2.1 Hotfix)
*   **検証:** 手動テストによる挙動確認